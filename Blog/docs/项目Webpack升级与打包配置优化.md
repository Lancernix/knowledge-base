å¤§æ¦‚ 23 å¹´çš„ 5 æœˆä»½ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒéªŒéœ€æ±‚çš„æ—¶å€™å‘ç°ï¼šåœç”¨ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œé¦–é¡µåˆ·æ–°åŠ è½½ä¸€æ¬¡è€—æ—¶éå¸¸é«˜ï¼Œå¤§çº¦è¦ 30sï¼Œéå¸¸å¤¸å¼ çš„æ—¶é—´äº†ã€‚çœ‹äº†ä¸€ä¸‹ç½‘ç»œè¯·æ±‚ï¼Œå‘ç°é—®é¢˜å‡ºåœ¨ä¸€ä¸ªä½“ç§¯è¾ƒå¤§çš„ js æ–‡ä»¶ä¸Šï¼ˆgzip å‹ç¼©å 1.6Mï¼Œæœªå‹ç¼©ä¸º 4.7Mï¼‰ï¼Œå•åŠ è½½è¿™ä¸ªæ–‡ä»¶å°±ç”¨æ‰äº† 23s å·¦å³çš„æ—¶é—´ã€‚è¿™å°±æœ‰ç‚¹å¥‡æ€ªäº†ï¼Œ1.6M çš„æ–‡ä»¶ï¼Œä¸‹è½½è¦ 23sï¼Œä¸åˆç†å‘€ğŸ¤”ã€‚ç„¶ååœ¨åŒäº‹ç”µè„‘ä¸Šè¯•äº†ä¸€ä¸‹ï¼Œå‘ç°ç›¸æ¯”ä¹‹ä¸‹ï¼Œè¦æ¯”æˆ‘è‡ªå·±çš„ç”µè„‘ä¸Šå¥½ä¸å°‘ã€‚å¥½å§ï¼ŒåŠå…¬ç½‘é’ˆå¯¹æˆ‘ğŸ˜¡ã€‚

è™½è¯´æˆ‘è¿™é‡ŒåŠ è½½è€—æ—¶é«˜æ˜¯ç½‘ç»œæŠ½é£çš„é—®é¢˜ï¼Œä½†æ˜¯é¡¹ç›®æ‰“åŒ…çš„äº§ç‰©ä¸­ç¡®å®å­˜åœ¨ä½“ç§¯è¿‡å¤§çš„ js æ–‡ä»¶ï¼Œè¯´æ˜é¡¹ç›®ç°åœ¨çš„ Webpack æ‰“åŒ…é…ç½®å­˜åœ¨ä¸å¤ªåˆç†çš„åœ°æ–¹ã€‚æ­£å¥½å½“æ—¶åœ¨æ·±å…¥å­¦ä¹  Webpack é…ç½®å’Œä¼˜åŒ–ï¼Œæ‹¿é¡¹ç›®æ¥éªŒè¯ä¸€ä¸‹å­¦ä¹ æˆæœï¼Œå²‚ä¸ç¾å“‰ï¼ˆç‹å¸å¾’.jpgğŸ˜ï¼‰ã€‚å¼€æğŸš€ï½ï½ï½

# æŠ½ç¦»é…ç½®æ–‡ä»¶

é¡¹ç›®çš„æ­å»ºç”¨äº†å†…éƒ¨æ²‰æ·€çš„ä¸€ä¸ªä¸­åå°é›†æˆæ¡†æ¶ï¼Œæ•´ä½“çš„å¼€å‘ä½“éªŒè¿˜æ˜¯ä¸é”™çš„ï¼Œä½†æ˜¯å¯¹äº Webpackã€Babel ç­‰ç¼–è¯‘æ„å»ºçš„é…ç½®å°è£…çš„ä¸å¤ªå¥½ï¼šæä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„åŸºç¡€ Webpack é…ç½®ï¼Œä½†æ²¡æœ‰é‡Šæ”¾è¿™äº›é…ç½®æ–‡ä»¶è€Œæ˜¯å°è£…æˆäº†ä¸€ä¸ªå•ç‹¬çš„åŒ…ã€‚è™½ç„¶æä¾›äº†ç”¨æ¥è¦†ç›–é»˜è®¤é…ç½®çš„æ–¹æ³•ï¼Œä½†ä»”ç»†ç›˜æŸ¥æ¢³ç†ä¹‹åå‘ç°å­˜åœ¨ä¸€äº›é—®é¢˜ï¼šæœ‰äº›è‡ªå®šä¹‰çš„é…ç½®é¡¹æ²¡æœ‰æŒ‰ç…§é¢„æœŸè¦†ç›–æ‰é»˜è®¤çš„é…ç½®é¡¹ï¼›`webpack-bundle-analyzer` æ²¡åŠæ³•æ­£å¸¸å¯åŠ¨ç­‰ã€‚æ²¡åŠæ³•ï¼Œåªèƒ½æŠ›å¼ƒè¿™ä¸ªåŒ…ï¼ŒæŠŠç°åœ¨çš„é…ç½®æŠ½ç¦»å‡ºæ¥ï¼Œç„¶åå†è¿›è¡Œåˆ†æä¼˜åŒ–äº†ã€‚

ç»è¿‡ä¸€é¡¿ CVã€åˆå¹¶ä¹‹åï¼Œé¡¹ç›®ä½¿ç”¨çš„ç¼–è¯‘æ‰“åŒ…é…ç½®å•ç‹¬æŠ½äº†å‡ºæ¥ï¼Œç›®å½•å’Œæ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

```shell
webpack
â”œâ”€â”€ babelConfig.js
â”œâ”€â”€ babelDepConfig.js
â”œâ”€â”€ terserOptions.js
â”œâ”€â”€ webpack.base.js
â”œâ”€â”€ webpack.dev.js
â””â”€â”€ webpack.prod.js
```

ä¹‹å‰çš„åŒ…ä¸­ï¼Œæ²¡æœ‰ç”¨åˆ° `webpack-dev-server`ï¼Œè€Œæ˜¯ä¸€ä¸ªè‡ªå·±å®ç°çš„å¼€å‘æœåŠ¡å™¨ã€‚æŠ½ç¦»å‡ºæ¥ä¹‹åï¼Œåˆ‡å›äº† `webpack-dev-server`ã€‚

# Webpackã€Babel å‡çº§

é¡¹ç›®ä½¿ç”¨çš„æ˜¯ Webpack4ï¼Œä¸ºäº†èƒ½å¤Ÿåˆ©ç”¨ Webpack5 çš„ç¼“å­˜ç³»ç»Ÿç‰¹æ€§æ¥æå‡å¼€å‘ç¯å¢ƒçš„ç¼–è¯‘é€Ÿåº¦ï¼Œæ‰€ä»¥é€‰æ‹©äº†å‡çº§ï¼ŒåŒæ—¶ä¹Ÿé¡ºä¾¿å‡çº§äº†ä¸€ä¸‹ Babel ç›¸å…³çš„åŒ…ã€‚

å‡çº§çš„è¿‡ç¨‹ç›¸å¯¹æ¯”è¾ƒé¡ºåˆ©ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼š

- Webpack5 å†…ç½®äº†å¯¹èµ„æºæ¨¡å—ï¼ˆå›¾ç‰‡ã€å­—ä½“ã€media ç­‰ï¼‰çš„è§£æå’Œå¤„ç†ï¼Œæ‰€ä»¥ 4 ä¸­å¸¸ç”¨çš„ `raw-loader`ã€`url-loader`ã€`file-loader` å·²ç»ä¸å†éœ€è¦äº†ã€‚è¿™é‡Œçš„é…ç½®é¡¹éœ€è¦è¿›è¡Œæ›´æ”¹ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ [Webpack ä¸­æ–‡æ–‡æ¡£](https://www.webpackjs.com/guides/asset-modules/)
- Babel å‡çº§åˆ° v7.18 ä¹‹åï¼Œ`@babel/preset-env` å·²ç»å¯ä»¥æ”¯æŒ `async/await/generator` çš„é™çº§ç¼–è¯‘äº†ã€‚å¦‚æœé¡¹ç›®ä¸­é‡‡ç”¨çš„æ˜¯ `usage: 'entry'` çš„ç­–ç•¥ï¼Œå¯ä»¥åœ¨å…¥å£æ–‡ä»¶ä¸­æ”¾å¿ƒåœ°åˆ é™¤å¼•å…¥è¯­å¥ `import 'regenerator-runtime/runtime'` äº†
- å‡çº§ä¹‹åå¯åŠ¨é¡¹ç›®å¯èƒ½ä¼šå¤±è´¥ï¼Œå‡ºç°ç±»ä¼¼ `Module not found: Error: Package path ./helpers/esm/regeneratorRuntime is not exported from package @ant-design\pro-layout\node_modules@babel\runtime (see exports field in \node_modules@ant-design\pro-layout\node_modules@babel\runtime\package.json)` çš„ç¼–è¯‘é”™è¯¯ã€‚è¿™æ˜¯ç”±äº `@ant-design/pro-layout` æ‰€ä¾èµ–çš„ `@babel/runtime` ç‰ˆæœ¬ä½äº v7.18ï¼Œè¿˜æ²¡æœ‰å†…ç½® `regeneratorRuntime`ã€‚è™½ç„¶æˆ‘ä»¬é¡¹ç›®ä¸­å·²ç»ç”¨äº†é«˜ç‰ˆæœ¬çš„ `@babel/runtime`ï¼Œä½† `@ant-design/pro-layout` å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡ `npm dedupe` å‘½ä»¤æ›´æ–°ä¸€ä¸‹é¡¹ç›®çš„ä¾èµ–æ ‘ï¼Œè®© `@ant-design/pro-layout` ä½¿ç”¨é«˜ç‰ˆæœ¬çš„ `@babel/runtime`ã€‚å…¶ä»–æ–¹æ³•å¯å‚è€ƒ [issue](https://github.com/ant-design/pro-components/issues/5273)

# æ„å»ºäº§ç‰©åˆ†æ

è¿™é‡Œä¸»è¦ç”¨åˆ°çš„å·¥å…·å°±æ˜¯ `webpack-bundle-analyzer` è¿™ä¸ªæ’ä»¶äº†ã€‚å®‰è£…å®Œæˆåç®€å•é…ç½®ä¸€ä¸‹ï¼Œæ’ä»¶å°±ä¼šåœ¨æ„å»ºå®Œæˆä¹‹åè‡ªåŠ¨å¯åŠ¨ä¸€ä¸ªæµè§ˆå™¨é¡µé¢ï¼Œå°†æˆ‘ä»¬çš„æ„å»ºäº§ç‰©è¿›è¡Œä¸€ä¸ªå¯è§†åŒ–å±•ç¤ºã€‚

## æ•´ä½“æ¦‚è§ˆ

![ä¼˜åŒ–å‰å¸¦ä½“ç§¯.png](https://cdn.nlark.com/yuque/0/2023/png/12433539/1685871147776-1e42e545-9038-4299-8090-d4bcf0876c6c.png#averageHue=%2383dd84&clientId=u58e56988-9e40-4&from=ui&id=uc68ba64f&originHeight=1330&originWidth=2560&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1100044&status=done&style=none&taskId=u50d116a3-8ce0-4eba-a2ee-042a12bbcc2&title=)

é€šè¿‡ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæœ€ç»ˆäº§å‡ºçš„ js æ–‡ä»¶ä¸­ï¼Œæœ‰ä¸¤ä¸ªä½“ç§¯æ˜æ˜¾è¾ƒå¤§ï¼šä¸€ä¸ª 3.07Mï¼Œä¸€ä¸ª 4.64Mã€‚å‰è€…æ˜¯é¡¹ç›®ä½¿ç”¨çš„ä¸€ä¸ªåä¸º rule_config çš„åŒ…ï¼Œåè€…æ˜¯é¡¹ç›®æ‰€ç”¨åˆ°çš„ node_modules ä¸­å‰©ä½™åŒ…çš„é›†åˆã€‚æˆ‘ä»¬éœ€è¦è¿›è¡Œä¼˜åŒ–çš„å°±æ˜¯è¿™ä¸¤ä¸ª js æ–‡ä»¶ï¼Œå…¶ä»–çš„ js æ–‡ä»¶éƒ½æ˜¯é‡‡ç”¨å¼‚æ­¥åŠ è½½çš„é¡µé¢æ¨¡å—ï¼Œä½“ç§¯ä¹Ÿéƒ½æ­£å¸¸ï¼Œæ— éœ€è€ƒè™‘ã€‚

## å­˜åœ¨é—®é¢˜

æ¥ä¸‹æ¥é€šè¿‡å¯¹è¿™ä¸ªä¸¤ä¸ªå¤§æ–‡ä»¶çš„æ„æˆåˆ†æï¼Œå¤§æ¦‚æ€»ç»“å‡ºäº†ä»¥ä¸‹çš„å‡ ä¸ªé—®é¢˜ï¼š

- `@ant-design/icons`ã€`@ant-design/pro-layout` æ²¡æœ‰æŒ‰éœ€å¼•å…¥ï¼Œè€Œæ˜¯å…¨é‡å¼•å…¥ã€‚é¡¹ç›®ä¸­å®é™…ä¸Šåªç”¨äº† 10 ä¸ªå·¦å³çš„ iconï¼Œ`@ant-design/pro-layout` ä¸­ä¹Ÿåªç”¨äº† `WaterMark` è¿™ä¸ªç»„ä»¶

![@antd-designå‰.png](https://cdn.nlark.com/yuque/0/2023/png/12433539/1685872416861-699c533f-d197-4eff-bb97-9da2eb827fc8.png#averageHue=%237adbd7&clientId=u58e56988-9e40-4&from=ui&height=510&id=qXODb&originHeight=680&originWidth=700&originalType=binary&ratio=2&rotation=0&showTitle=false&size=154638&status=done&style=none&taskId=ua1d796b6-2b10-4954-bd22-6b913bf6976&title=&width=525)

- è®¸å¤šåŒ…å­˜åœ¨é‡å¤å¼•å…¥çš„é—®é¢˜ï¼Œæ²¡æœ‰å¯¹è¿™äº›åŸºç¡€çš„åŒ…è¿›è¡Œå•ç‹¬æŠ½ç¦»ï¼Œæ¯”å¦‚ `lodash`ã€`jquery`ã€`@ant-design/icons` ç­‰

![å…¬å…±åº“å‰.png](https://cdn.nlark.com/yuque/0/2023/png/12433539/1685872933541-6c105e27-e26f-45e8-96c0-9655a5c453ad.png#averageHue=%236bd6d3&clientId=u58e56988-9e40-4&from=ui&height=609&id=u7df94175&originHeight=812&originWidth=1500&originalType=binary&ratio=2&rotation=0&showTitle=false&size=248183&status=done&style=none&taskId=ufe7dcd66-3309-41ee-bfe5-4268ea40662&title=&width=1125)

- `momentjs` ä¸­å­˜åœ¨å¤§é‡æ²¡æœ‰ç”¨åˆ°çš„æœ¬åœ°åŒ–æ–‡ä»¶ï¼Œé¡¹ç›®ä¸­å›½é™…åŒ–åªæœ‰ä¸­æ–‡å’Œè‹±æ–‡ä¸¤ç§ï¼Œå…¶ä»–çš„éƒ½ä¸éœ€è¦

![momentjså‰.png](https://cdn.nlark.com/yuque/0/2023/png/12433539/1685873119853-22cab520-c52e-4b75-aab8-67e735f689a9.png#averageHue=%237ad7d4&clientId=u58e56988-9e40-4&from=ui&id=u4d8deb31&originHeight=350&originWidth=698&originalType=binary&ratio=2&rotation=0&showTitle=false&size=82454&status=done&style=none&taskId=u43f4553c-478d-4a15-ad38-20c07f15430&title=)

- `lodash` æ²¡æœ‰æŒ‰éœ€å¼•å…¥

# ä¼˜åŒ–æ–¹æ³•

é’ˆå¯¹ä¸Šé¢æ‰¾åˆ°çš„å‡ ä¸ªé—®é¢˜ï¼Œå…¶å®åŠæ³•ä¹Ÿéƒ½æ¯”è¾ƒç®€å•ï¼Œæ— éå°±æ˜¯æ­£ç¡®æŒ‰éœ€å¼•å…¥ã€æŠ½ç¦»å…¬å…±åŒ…ä»¥åŠå»æ‰æ— ç”¨çš„æœ¬åœ°åŒ–é—®é¢˜ã€‚å¤§éƒ¨åˆ†é—®é¢˜è§£å†³éƒ½ç›¸å¯¹ç®€å•ï¼Œè€Œ `antd`ã€`@ant-design/icons`ã€`@ant-design/pro-layout` æŒ‰éœ€å¼•å…¥è¿™ä¸ªåœ°æ–¹èŠ±äº†ä¸å°‘æ—¶é—´æ‰è§£å†³ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»æ˜“åˆ°éš¾ï¼Œä¸€ä¸€äº†è§£ä¸€ä¸‹å¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚

## Lodash æŒ‰éœ€å¼•å…¥

æˆ‘ä»¬åœ¨ä½¿ç”¨ `lodash` çš„æ—¶å€™ï¼Œæœ‰ 3 ç§æ–¹å¼å¯ä»¥å®ç°æŒ‰éœ€å¼•å…¥ï¼š

- ä½¿ç”¨ `import sortBy from 'lodash/sortBy'` è€Œä¸æ˜¯ `import { sortBy, isEqual } from 'lodash'` æˆ– `import * as lodash from 'lodash'`
- ä½¿ç”¨ `lodash-es` è¿™ä¸ªåŒ…æ›¿ä»£ `lodash`ï¼Œ`lodash-es` åŸç”Ÿæ”¯æŒæŒ‰éœ€å¼•å…¥
- ä½¿ç”¨å¯¹åº”çš„ babel æ’ä»¶æ¥å®ŒæˆæŒ‰éœ€å¼•å…¥ï¼Œæ¯”å¦‚ `babel-plugin-lodash` æˆ–è€… `babel-plugin-import`

é¡¹ç›®ä¸­å¾ˆå¤šåœ°æ–¹å¼•å…¥ `lodash` ä½¿ç”¨çš„æ˜¯è§£æ„çš„æ–¹å¼å¼•å…¥çš„ï¼Œæ‰‹åŠ¨ä¸€ä¸ªä¸€ä¸ªä¿®æ”¹å¤ªè€—æ—¶é—´ï¼Œæ‰€ä»¥é‡‡ç”¨çš„æ˜¯ babel æ’ä»¶çš„æ–¹å¼è§£å†³ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```javascript
// babelConfig.js
module.exports = {
	...
	plugins: [
		[
			resolve.sync('babel-plugin-import'),
			{ libraryName: 'lodash', libraryDirectory: '', camel2DashComponentName: false },
		],
	].filter(Boolean),
};
```

## æŠ½ç¦»å…¬å…±åŒ…ï¼Œæ¶ˆé™¤é‡å¤å¼•å…¥

é¡¹ç›®ä¹‹å‰å°† node_modules ä¸­çš„æ‰€æœ‰åŒ…ï¼ˆé™¤ rule_config ä¹‹å¤–ï¼‰éƒ½æ”¾åœ¨äº†ä¸€ä¸ª chunk ä¸­ï¼Œè¿™é‡Œå¯ä»¥å°†å¸¸ç”¨çš„åŒ…è¿›è¡Œä¸€ä¸ªæŠ½ç¦»ï¼š`react`ã€`react-dom`ã€`react-router-dom`ã€`antd`ã€`@ant-design/icons` æ‹†åˆ°ä¸€ä¸ª chunk ä¸­ï¼›`lodash`ã€`core-js`ã€`moment`ã€`jquery` æ‹†åˆ°å¦ä¸€ä¸ª chunk ä¸­ï¼Œå‰©ä¸‹çš„åˆ™éƒ½å½’åˆ°ä¸€ä¸ª chunk ä¸­ã€‚è¿™æ ·ï¼Œæ¶ˆé™¤äº†é‡å¤å¼•å…¥çš„é—®é¢˜ï¼Œä¹Ÿå°†å¤§ä½“ç§¯çš„ chunk æ‹†åˆ†æˆäº†å°çš„ chunkã€‚é…ç½®ä»£ç å¦‚ä¸‹ï¼š

```javascript
splitChunks: {
	...
	cacheGroups: {
		basicVendors: {
			name: `chunk-basic-vendors`,
			test: /[\\/]node_modules[\\/](react|react-dom|react-router-dom|antd|@ant-design\/icons)[\\/]/,
			priority: 0,
			chunks: 'all'
		},
		popularVendors: {
			name: `chunk-popular-vendors`,
			test: /[\\/]node_modules[\\/](lodash|core-js|moment|.+jquery)[\\/]/,
			priority: -10,
			chunks: 'all'
		},
		vendors: {
			name: `chunk-vendors`,
			test: /[\\/]node_modules[\\/]/,
			priority: -20,
			chunks: 'all'
		},
	...
	},
},
```

## å»é™¤ Momemtjs æ— ç”¨çš„æœ¬åœ°åŒ–æ–‡ä»¶

è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨ moment ä¸“é—¨çš„æ’ä»¶æ¥å®Œæˆè¿™ä¸ªå·¥ä½œï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Webpack æä¾›çš„ `IgnorePlugin` æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸ªå·¥ä½œã€‚é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ `IgnorePlugin`ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```javascript
plugins: [
	...
	// å»æ‰ moment ä¸­æ²¡æœ‰ç”¨åˆ°çš„æœ¬åœ°åŒ–æ–‡ä»¶
	new IgnorePlugin({
		resourceRegExp: /^\.\/locale$/,
		contextRegExp: /moment$/,
	}),
].filter(Boolean)
```

## ç»„ä»¶åº“æŒ‰éœ€å¼•å…¥

æŸ¥é˜…å®˜æ–¹æ–‡æ¡£å¯ä»¥çŸ¥é“ï¼Œä» 4 ç‰ˆæœ¬å¼€å§‹ï¼Œ`antd` å·²ç»æ”¯æŒäº† js æ–‡ä»¶çš„æŒ‰éœ€å¼•å…¥ï¼Œ`@ant-design/icons`ã€`@ant-design/pro-layout` åŒæ ·ä¹Ÿæ”¯æŒï¼Œä½¿ç”¨çš„æ—¶å€™å¹¶ä¸éœ€è¦åšå…¶ä»–é¢å¤–çš„é…ç½®ã€‚ä½†æ˜¯é¡¹ç›®æœ€ç»ˆæ‰“åŒ…å‡ºæ¥çš„äº§ç‰©ç¡®å®æ²¡æœ‰åšåˆ°æŒ‰éœ€å¼•å…¥ğŸ¤”â€¦â€¦ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ `babel-plugin-import` é…ç½®çš„ä¸å¯¹ï¼Œç»è¿‡æŠ˜è…¾ä¹‹åå‘ç°å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ã€‚ç„¶åæŸ¥äº†ä¸€äº›èµ„æ–™ï¼Œä¹Ÿæ²¡æœ‰æœ‰ç”¨çš„åŠæ³•ã€‚æœ€åå‘ç°ï¼Œå…¶å®æ˜¯ Webpack é…ç½®ä¸­çš„ `resolve` é…ç½®é¡¹æœ‰ç‚¹é—®é¢˜ã€‚

é¡¹ç›®ä¸­åŸæ¥çš„é…ç½®æ˜¯è¿™æ ·çš„ï¼š

```javascript
module.exports = {
	...
	resolve: {
		...
		mainFields: ['browser', 'jsnext:main', 'main'],
	},
	target: 'web',
}
```

é—®é¢˜å°±å‡ºåœ¨ `mainFields` è¿™ä¸ªå­—æ®µï¼Œ`mainFields` å­—æ®µçš„ä½œç”¨æ˜¯å½“ä» npm åŒ…ä¸­å¯¼å…¥æ¨¡å—æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹å°†å†³å®šä½¿ç”¨ `package.json` å“ªä¸ªå­—æ®µå¯¼å…¥æ¨¡å—ï¼Œæœ‰å¤šä¸ªå€¼çš„æ—¶å€™ï¼Œä¼šä»å‰å¾€åè¿›è¡ŒæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ä¸ºæ­¢ã€‚ä»¥ antd ä¸ºä¾‹ï¼ŒæŸ¥çœ‹ `antd/package.json` å¯ä»¥å‘ç°ï¼Œå…¶ä¸­è®¾ç½®äº† `module`ã€`main` ä¸¤ä¸ªå­—æ®µï¼š

![image.png](https://cdn.nlark.com/yuque/0/2023/png/12433539/1686018032812-c66d6574-9675-4677-b457-490fc0839e51.png#averageHue=%23282c34&clientId=u6ba04731-a495-4&from=paste&height=130&id=ub608f328&originHeight=130&originWidth=397&originalType=binary&ratio=1&rotation=0&showTitle=false&size=13212&status=done&style=none&taskId=ue889cad4-2253-4589-98af-99bbb01e707&title=&width=397)

ç»å¤§å¤šæ•°çš„åº“éƒ½ä¼šæä¾›è¿™ä¸¤ä¸ªé…ç½®é¡¹ï¼Œ`module` å¯¹åº”çš„æ–‡ä»¶æ˜¯æ”¯æŒ ES Module çš„æ¨¡å—è¯­æ³•çš„ï¼Œèƒ½å¤Ÿå¾ˆå¥½çš„è¿›è¡Œ Tree Shakingï¼›è€Œ `main` åˆ™å¯¹åº”çš„æ˜¯ commonjs è¯­æ³•çš„æ–‡ä»¶ï¼›æœ‰äº›åº“è¿˜ä¼šæä¾› `browser` ç­‰å­—æ®µï¼Œç”¨äºåœ¨å…¶ä»–ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

ä¸éš¾å‘ç°é¡¹ç›®ä¸­çš„ `jsnext:main` é…ç½®é¡¹æœ‰ç‚¹é—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹æˆ `module`ï¼Œå…¶å® Webpack çš„ `target` ä¸º `web` æ—¶ï¼Œ`mainFields` çš„é»˜è®¤å€¼å°±æ˜¯ `['browser', 'module', 'main']`ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå¯ä»¥ä¸ç”¨è®¾ç½®ï¼Œç›´æ¥ä½¿ç”¨é»˜è®¤å€¼å³å¯ã€‚ä¿®æ­£è¿™ä¸€ç‚¹ä¹‹åï¼Œè¿™å‡ ä¸ªåŒ…çš„æŒ‰éœ€å¼•å…¥å°±å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚

# ä¼˜åŒ–ç»“æœ

**ä¼˜åŒ–ä¹‹åï¼Œé¡¹ç›®çš„æ„å»ºä½“ç§¯ç›¸æ¯”ä¹‹å‰æœ‰äº†å¤§å¹…çš„å‹ç¼©ï¼Œç”±åŸæ¥çš„ 13.5M å‡å°‘åˆ° 7.45Mã€‚åŒæ—¶ï¼Œæ‰€æœ‰çš„ js æ–‡ä»¶ä½“ç§¯éƒ½æ§åˆ¶åœ¨äº† 1.5M ä»¥ä¸‹ï¼ˆæœªå‹ç¼©ï¼‰ã€‚ä¼˜åŒ–æ•ˆæœåˆ™è¡¨ç°åœ¨ Jenkins æ‰“åŒ…è€—æ—¶ç”±åŸæ¥çš„ 5min ç¼©çŸ­ä¸º 3minï¼Œé¦–é¡µåŠ è½½çš„é€Ÿåº¦ä¹Ÿæœ‰ä¸€å®šçš„æå‡**ã€‚

æ”¾ä¸€ä¸‹ä¼˜åŒ–åçš„æ„å»ºäº§ç‰©å›¾ï¼Œå¯ä»¥å‚ç…§ä¼˜åŒ–å‰çš„åšä¸€ä¸ªå¯¹æ¯”ï¼š

![ä¼˜åŒ–åå¸¦ä½“ç§¯.png](https://cdn.nlark.com/yuque/0/2023/png/12433539/1686020350635-9a30ee7a-aa6c-4f84-8cd2-8c0b937ac635.png#averageHue=%238fdac7&clientId=u6ba04731-a495-4&from=drop&id=uea0b7146&originHeight=1330&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1104815&status=done&style=none&taskId=ua414a2d9-90b1-4b0e-b23e-e3b00383d82&title=)

![ä¼˜åŒ–å.png](https://cdn.nlark.com/yuque/0/2023/png/12433539/1686020849070-07076c4e-ecee-433c-8ec5-8e15e6c8bf20.png#averageHue=%2390dacb&clientId=u6ba04731-a495-4&from=drop&id=u251f70b5&originHeight=1330&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=859972&status=done&style=none&taskId=uba020bb7-c32b-47c3-accb-396899c2e8b&title=)

# äºŒæ¬¡ä¼˜åŒ–

24 å¹´ 4 æœˆä»½ï¼Œé¡¹ç›®åšäº† dayjs æ›¿æ¢ moment çš„ä¼˜åŒ–ã€‚åœ¨éªŒè¯ä¼˜åŒ–æ˜¯å¦ç”Ÿæ•ˆçš„è¿‡ç¨‹ä¸­å‘ç°ï¼šé¡¹ç›®æ‰“åŒ…ä¹‹åçš„ä½“ç§¯å¿«æ¥è¿‘ 10M äº†ï¼ï¼Ÿæˆ‘ç›´è§‰ä¸Šæ„Ÿè§‰ä¸åº”è¯¥æœ‰è¿™ä¹ˆå¤§ï¼Œè™½ç„¶æ¥è¿‘ä¸€å¹´å¤šçš„æ—¶é—´é‡Œæœ‰æ–°çš„éœ€æ±‚ï¼Œä½“ç§¯è‚¯å®šä¼šæœ‰å¢é•¿ï¼Œä½†å¢åŠ äº† 2M+ï¼Œä¸å¤ªåˆç†ã€‚ç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œæœ€ç»ˆç¡®å®šæ˜¯**ä¹‹å‰å†™çš„æ‹† chunk è§„åˆ™æœ‰ç‚¹é—®é¢˜ï¼Œå°‘åŠ äº†ä¸€ä¸ªé‡è¦çš„å±æ€§ï¼š `reuseExistingChunk`**ã€‚

`reuseExistingChunk`Â é€‰é¡¹çš„ä½œç”¨æ˜¯å†³å®šæ˜¯å¦é‡ç”¨å·²ç»å­˜åœ¨çš„ä»£ç å—ï¼Œå…·ä½“åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œå°±æ˜¯åœ¨æ‹† chunk æ—¶ï¼Œ`reuseExistingChunk`Â è®¾ç½®ä¸º `true` ä¼šç¡®ä¿ä¼˜å…ˆçº§ä½çš„ chunk å°½å¯èƒ½åœ°å…±äº«ä¼˜å…ˆçº§é«˜çš„ chunk ä¸­çš„ä»£ç ï¼Œèƒ½å¤Ÿè¿›ä¸€æ­¥é™ä½æ‰“åŒ…ä½“ç§¯ï¼Œä¼˜åŒ–é¡µé¢åŠ è½½é€Ÿåº¦ã€‚

æ‰¾åˆ°é—®é¢˜ä¹‹åï¼Œå¯¹ splitChunk é…ç½®åˆè¿›è¡Œäº†ä¸€æ¬¡ä¼˜åŒ–ï¼Œä¼˜åŒ–åçš„é…ç½®å¦‚ä¸‹ï¼š

```javascript
splitChunks: {
	chunks: 'all',
	minSize: 102400,
	minChunks: 1,
	maxAsyncRequests: 5,
	maxInitialRequests: 6,
	cacheGroups: {
		basicVendors: {
			name: `chunk-basic-vendors`,
			test: /[\\/]node_modules[\\/](react|react-dom|react-router-dom|antd|@ant-design\/icons)[\\/]/,
			priority: 30,
			chunks: 'all',
			reuseExistingChunk: true
		},
		popularVendors: {
			name: `chunk-popular-vendors`,
			test: /[\\/]node_modules[\\/](lodash|core-js|dayjs|lodash-es|moment)[\\/]/,
			priority: 20,
			chunks: 'all',
			reuseExistingChunk: true
		},
		// åªæœ‰ä¸€ä¸ªé¡µé¢ç”¨äº†ruleconfigè¿™ä¸ªåŒ…ï¼Œå…¶ä»–åœ°æ–¹ç”¨ä¸åˆ°ï¼Œè¿™ä¸ªåŒ…åŠå…¶ä¾èµ–æ¯”è¾ƒå¤§
		// æ‰€ä»¥å•ç‹¬æ‹†å‡ºæ¥ï¼ŒæŒ‰éœ€åŠ è½½ä¸å¯¹å…¶ä»–é¡µé¢é€ æˆå½±å“
		ruleconfigVendor: {
			name: `chunk-ruleconfig-vendor`,
			test: /[\\/]node_modules[\\/](ruleconfig|@antv\/x6|@antv\/x6-react-shape|jquery)[\\/]/,
			priority: 10,
			chunks: 'all',
			reuseExistingChunk: true
		},
		vendors: {
			name: `chunk-vendors`,
			test: /[\\/]node_modules[\\/]/,
			priority: 0,
			chunks: 'all',
			reuseExistingChunk: true
		},
		common: {
			name: `chunk-common`,
			minChunks: 2,
			priority: -10,
			chunks: 'all',
			reuseExistingChunk: true,
		},
	},
},
```

é€šè¿‡è¿™æ¬¡çš„ä¼˜åŒ–ï¼Œæ‰“åŒ…ä¹‹åçš„ä½“ç§¯é™ä½åˆ°äº† 5.4Mã€‚äº§ç‰©å¯è§†åŒ–å›¾å¦‚ä¸‹ï¼š

![äºŒæ¬¡ä¼˜åŒ–å¯è§†åŒ–ç»“æœ](../pics/webpack-1.png)

# æ€»ç»“

é¡¹ç›®ä¼˜åŒ–ï¼Œå…¶å®æ˜¯ä¸€ä¸ªæŒç»­æ€§çš„å·¥ä½œã€‚åœ¨ä¸€ä¸ªé˜¶æ®µæœ‰ä¸€ä¸ªè¾ƒä¼˜çš„è§£ï¼Œä½†éšç€è¿­ä»£è¿›è¡Œä¸‹å»ï¼Œå¯èƒ½éœ€è¦è¿›è¡Œå†æ¬¡ä¼˜åŒ–ã€‚è¿™æ ·æ‰å¯ä»¥ä¿æŒé¡¹ç›®çš„ç¨³å®šæ€§ã€æ€§èƒ½åœ¨ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ°´å¹³ã€‚

ä¼˜åŒ–æ˜¯ä¸€ä¸ªæœ‰ç‚¹åƒåŠ›ä¸è®¨å¥½çš„æ´»ï¼Œå¯èƒ½ä½ çš„ä¼˜åŒ–å¹¶æ²¡æœ‰å¸¦æ¥å¾ˆæ˜æ˜¾çš„æ„ŸçŸ¥ï¼ˆé™¤éé¡¹ç›®å·²ç»åˆ°äº†ä¸ä¼˜åŒ–å·²ç»å¿«ä¸èƒ½ç”¨çš„é˜¶æ®µäº†ï¼‰ã€‚ä½†ä¼˜åŒ–çš„è¿‡ç¨‹ï¼Œå¯¹äºæå‡è‡ªå·±å‘ç°é—®é¢˜ã€åˆ†æé—®é¢˜ã€è§£å†³é—®é¢˜çš„èƒ½åŠ›éå¸¸æœ‰å¸®åŠ©ã€‚å¯èƒ½æœ‰äº›åŒå­¦å¯¹äºé¡¹ç›®ä¸­è¿™ç±»åŸºç¡€é…ç½®çš„æ€åº¦æ˜¯ " é¡¹ç›®èƒ½è·‘å°±ä¸åŠ¨ "ã€" ä¸æ•¢åŠ¨ "ï¼Œå…¶å®ä¹Ÿæ²¡å¿…è¦ã€‚ç°åœ¨å€ŸåŠ© GPT è¿™ç±» AI çš„å¸®åŠ©ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«çš„äº†è§£ä¸€äº›ä¸å¤ªæ˜ç™½çš„é¢†åŸŸæˆ–è€…æ›´åŠ å…·ä½“çš„ä¸€æ®µä»£ç ï¼Œå†ç»“åˆå®˜æ–¹æ–‡æ¡£å’Œè‡ªå·±çš„ç†è§£ï¼Œå®Œæˆä¸€é¡¹è¾ƒä¸ºå¤æ‚çš„ä¼˜åŒ–ä¹Ÿæ˜¯æ²¡ä»€ä¹ˆå¤§é—®é¢˜çš„ã€‚å¤§å®¶éƒ½å¯ä»¥è¯•ä¸€è¯•ï¼Œå®è·µæ‰æœ‰æ”¶è·å˜›ï¼ŒåŠ¨åŠ¨æ‰‹æ²¡å•¥åå¤„ã€‚

OKï¼Œç¢ç¢å¿µç»“æŸã€‚å®Œæ´»å„¿ï¼
